<div ng-controller="plmProductExceptionDetailCtrl" class="bigdata">


    <!--------------------- 按钮--->
    <div class="bg-gray-white p5">
        <div class=" pull-right ml10">

            <div class="btn-group btn-group-xs">
                <button class="btn btn-default" permission-btn="btnSave"   ng-click="btnSave(plmProductExceptionInfoForm.$invalid)" ng-disabled="headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='ABANDONED'" data-validate-form="plmProductExceptionInfoForm"></button>
                <button class="btn btn-default" permission-btn="btnSubmit"   ng-click="btnSubmit(plmProductExceptionInfoForm.$invalid)" ng-disabled = "headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='FOLLOWING'" data-validate-form="plmProductExceptionInfoForm"></button>
                <button class="btn btn-default" permission-btn="btnDiscard"   ng-click="btnDiscard()" ng-disabled = "!headerData.plmProductExceptionInfoId||headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='ABANDONED'||headerData.productExceptionBillStatus==='FOLLOWING'"></button>
                <button class="btn btn-default" permission-btn="GB"   ng-click="GB(plmProductExceptionInfoForm.$invalid)" ng-disabled = "headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='ABANDONED'"></button>

            </div>


        </div>
        <div class="btn-group btn-group-xs ">
            <button class="btn btn-primary" ng-click="fullWindow($event)"><i class="fa fa-square-o"></i>数据全屏
            </button>
        </div>
    </div>
    <!---------------------  / .按钮  --->
    <div main-scroll-style data-des="此节点必需－用户计算滚动区域高度">
        <div class="nicescroll-height  bg-white " ng-nicescroll
             nice-option="{{niceOpction}}"
             data-des="此节点必需-滚动内容及指令">

            <!--------------------- 输入表单  --->

            <div class=" mt10 pb5  oh"
                 data-des="此节点必需－用于识别输入表单的指令">

                <form id="plmProductExceptionInfoForm" name="plmProductExceptionInfoForm">
                    <header class="col-xs-12 mb10">
                        <i class="fa fa-cog" aria-hidden="true"></i>
                        <span>异常信息</span>
                    </header>


                    <div class="form-group col-xs-4 col-md-3">
                        <div class="input-group input-group-xs">

                            <label class="input-group-addon bn">
                                <span class="w100">新增单号</span>
                            </label>

                            <input type="text" ng-disabled="true" class="form-control radius3"
                                   ng-model="headerData.productExceptionNum">
                        </div>
                    </div>


                    <div class="form-group col-xs-4 col-md-3">
                        <div class="input-group input-group-xs">

                            <label class="input-group-addon bn">
                                <span class="w100">打开日期</span>
                            </label>

                            <input type="text" class="form-control radius3"
                                   ng-model="headerData.startDate"
                                   ng-disabled="true"
                            >

                        </div>
                    </div>


                    <div class="form-group col-xs-4 col-md-3">
                        <div class="input-group input-group-xs">

                            <label class="input-group-addon bn">
                                <span class="w100"> 单据状态</span>
                            </label>

                            <div lookup-code="PLM_PRODUCT_EXEP_BILL_STATUS" data-required="true" ng-model="headerData.productExceptionBillStatus"
                                 required  id="productExceptionBillStatus" ng-disabled="true" name="productExceptionBillStatus">
                            </div>

                        </div>
                    </div>


                    <div class="form-group col-xs-4 col-md-3">
                        <div class="input-group input-group-xs">

                            <label class="input-group-addon bn">
                                <span class="w100">创建人</span>
                            </label>

                            <input type="text" class="form-control radius3"
                                   ng-model="headerData.creator"
                                   ng-disabled="true"
                            >

                        </div>
                    </div>


                    <div class="form-group col-xs-4 col-md-3">
                        <div class="input-group input-group-xs">

                            <label class="input-group-addon bn">
                                <span class="w100"><i class="red">*</i>异常来源</span>
                            </label>

                            <div lookup-code="PLM_EXCEPTION_SOURCE" data-required="true" ng-model="headerData.exceptionSource"
                                 required  id="exceptionSource" ng-disabled="headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='ABANDONED'" name="exceptionSource">
                            </div>

                        </div>
                    </div>


                    <div class="form-group col-xs-4 col-md-3">
                        <div class="input-group input-group-xs">

                            <label class="input-group-addon bn">
                                <span class="w100"><i class="red">*</i>类别</span>
                            </label>

                            <select class="selectpicker show-tick form-control" ng-model="headerData.exceptionCategory" required ng-disabled="!headerData.exceptionSource||headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='ABANDONED'" data-live-search="true">
                                <option value="">请选择</option>
                                <option ng-if="headerData.exceptionSource!=='GOVERNMENT'"value="ADVERSE_REACTION">不良反应</option>
                                <option ng-if="headerData.exceptionSource=='GOVERNMENT'" value="CUSTOMER">顾客质量问题反馈</option>
                                <option ng-if="headerData.exceptionSource=='GOVERNMENT'" value="DM_OR_POP">DM/POP等广告宣称</option>
                                <option ng-if="headerData.exceptionSource=='GOVERNMENT'" value="EVIDENCE">索证（含索取检测报告）</option>
                                <option ng-if="headerData.exceptionSource!=='GOVERNMENT'" value="FUNCTION">使用功能问题</option>
                                <option ng-if="headerData.exceptionSource=='GOVERNMENT'" value="GOVERNMENT">政府及相关方检测结果通报</option>
                                <option ng-if="headerData.exceptionSource!=='GOVERNMENT'" value="MATERIAL">质量问题（料体）</option>
                                <option value="OTHERS">其他</option>
                                <option ng-if="headerData.exceptionSource!=='GOVERNMENT'" value="PACKAGE">质量问题（包材）</option>
                                <option value="PRODUCT">产品宣称</option>
                                <option ng-if="headerData.exceptionSource!=='GOVERNMENT'" value="TECHNOLOGY">生产工艺问题</option>
                            </select>

                        </div>
                    </div>


                    <div class="form-group col-xs-4 col-md-3">
                        <div class="input-group input-group-xs">

                            <label class="input-group-addon bn">
                                <span class="w100"><i class="red">*</i>投诉店铺号</span>
                            </label>

                            <input type="text" class="form-control radius3" required
                                    ng-disabled="headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='ABANDONED'"
                                   ng-model="headerData.complaintShopNumber">
                        </div>
                    </div>


                    <div class="form-group col-xs-4 col-md-3">
                        <div class="input-group input-group-xs">

                            <label class="input-group-addon bn">
                                <span class="w100"><i class="red">*</i>店铺所在城市</span>
                            </label>

                            <input type="text" required class="form-control radius3"
                                   ng-disabled="headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='ABANDONED'"
                                   ng-model="headerData.cityOfShop">
                        </div>
                    </div>


                    <div class="form-group col-xs-4 col-md-3">
                        <div class="input-group input-group-xs">
                            <label class="input-group-addon bn"><span
                                    class="w100"><i class="red">*</i>QA响应时间:</span></label>
                            <input type="text" class="form-control radius3 input-xs"
                                   date-time-picker data-is-today="false" name="qaResponseTime"
                                   data-date-format="yyyy-mm-dd"
                                   required
                                   ng-disabled="headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='ABANDONED'"
                                   data-min-View="2" ng-model="headerData.qaResponseTime"
                                   autocomplete="off">
                        </div>
                    </div>


                    <div class="form-group col-xs-4 col-md-3">
                        <div class="input-group input-group-xs">

                            <label class="input-group-addon bn">
                                <span class="w100">部门</span>
                            </label>

                            <input type="text" ng-disabled="true" class="form-control radius3"
                                   ng-model="headerData.department">
                        </div>
                    </div>


                    <div class="form-group col-xs-12 col-md-12">
                        <div class="input-group input-group-xs">

                            <label class="input-group-addon bn">
                                <span class="w100"><i class="red">*</i>详情</span>
                            </label>

                            <textarea class="form-control" rows="3" ng-model="headerData.detail" maxlength="500" placeholder="字数限制500"
                                      required name="detail" style="height: auto"
                                      ng-disabled="headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='ABANDONED'"></textarea>

                        </div>
                    </div>

                    <div class="row"></div>

                    <header class="col-xs-12 mb10">
                        <i class="fa fa-cog" aria-hidden="true"></i>
                        <span>处理结果</span>
                    </header>

                    <div class="form-group col-xs-4 col-md-3">
                        <div class="input-group input-group-xs">

                            <label class="input-group-addon bn">
                                <span class="w100">赔偿金额</span>
                            </label>

                            <input type="text"  class="form-control radius3"
                                   ng-disabled="headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='ABANDONED'"
                                   ng-model="headerData.indemnity">
                        </div>
                    </div>

                    <div class="form-group col-xs-4 col-md-3">
                        <div class="input-group input-group-xs">
                            <label class="input-group-addon bn"><span
                                    class="w100">关闭日期:</span></label>
                            <input type="text" class="form-control radius3 input-xs"
                                   date-time-picker data-is-today="false" name="endDate"
                                   data-date-format="yyyy-mm-dd"
                                   data-min-View="2" ng-model="headerData.endDate"
                                   disabled
                                   autocomplete="off">
                        </div>
                    </div>

                    <div class="form-group col-xs-4 col-md-3">
                        <div class="input-group input-group-xs">

                            <label class="input-group-addon bn">
                                <span class="w100">处理方式</span>
                            </label>

                            <div lookup-code="PLM_TREATMENT" ng-model="headerData.treatment"
                                 ng-disabled="headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='ABANDONED'"
                                 id="treatment" ng-disabled="false" name="treatment">
                            </div>

                        </div>
                    </div>

                    <div class="form-group col-xs-12 col-md-12">
                        <div class="input-group input-group-xs">

                            <label class="input-group-addon bn">
                                <span class="w100">处理结果</span>
                            </label>

                            <textarea class="form-control" rows="3" ng-model="headerData.results"
                                      ng-disabled="headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='ABANDONED'"
                                      maxlength="500" placeholder="字数限制500" name="detail" style="height: auto"></textarea>

                        </div>
                    </div>



                </form>
            </div>


            <div class="col-xs-12 col-md-12 br p0">

                <ul id="tab" class="nav nav-tabs">

                    <li class="active">
                        <a href="#exceptionProduct" data-toggle="tab"><i class="fa fa-list-alt"></i>
                            <label>异常产品</label></a>
                    </li>


                </ul>

                <div id="tabContent" class="tab-content">

                    <!-- 产品明细 -->
                    <div class="tab-pane fade in active col-md-12" id="exceptionProduct">
                        <div>
                            <label style="margin-left: 10px">&nbsp;</label>

                            <div class="btn-group btn-group-xs pull-right" ng-if="true">
                                <div class="btn-group btn-group-xs" ng-if="true">

                                    <button type="button" ng-click="addProductExceptionDetail()" class="btn btn-default btn-xs"
                                            id="addProductDetailButton"
                                            ng-disabled = "headerData.productExceptionBillStatus==='ABANDONED'||headerData.productExceptionBillStatus==='CLOSED'"
                                    >
                                        <i class="fa fa-plus">  新增</i>
                                    </button>

                                    <button type="button" ng-click="delProductExceptionDetail()" class="btn btn-default btn-xs"
                                            ng-disabled = "exceptionProductDataTable.selectRow==undefined||headerData.productExceptionBillStatus!=='ADDING'||headerData.productExceptionBillStatus==='CLOSED'"
                                            id="delProductDetailButton">
                                        <i class="fa fa-trash">  删除</i>
                                    </button>
                                </div>
                            </div>

                        </div>

                        <div class="data-table">
                            <table
                                    class="table table-bordered table-hover table-condensed">
                                <thead class="bg-gray-white" style="background-color: #E2EFEF">
                                <tr class="text-center">
                                    <th>序号</th>
                                    <th><i class="red">*</i>Barcode</th>
                                    <th><i class="red">*</i>货号</th>
                                    <!--<th><i class="red">*</i>项目名称</th>-->
                                    <!--<th><i class="red">*</i>产品名称</th>-->
                                    <th><i class="red">*</i>商品名称</th>
                                    <!--<th><i class="red">*</i>产品品类</th>-->
                                    <th><i class="red">*</i>供应商名称</th>
                                    <th><i class="red">*</i>生产商名称</th>
                                    <th>批号</th>
                                    <th>投诉样品数量</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr class="text-center" ng-repeat="row in exceptionProductDataTable"
                                    ng-class="{'active':exceptionProductDataTable.selectRow==$index}"
                                    ng-click="exceptionProductDataTable.selectRow=$index">
                                    <td>{{$index+1}}</td>
                                    <td>
                                        <div class="input-group input-group-xs">
                                            <input type="text" class="form-control radius3" ng-click="findDetail(row)" style="color: #1e90c2;cursor: pointer;"
                                                   ng-model="row.barcode" readonly>
                                            <span class="input-group-btn ng-scope">
                                                <button type="button"  ng-click="showExceptionProduct($index)"
                                                        ng-disabled ="headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='ABANDONED'"
                                                        class="btn btn-default"><i class="fa fa-search"></i></button>
                                            </span>
                                        </div>
                                    </td>
                                    <td><input class="form-control input-xs" ng-model="row.productNo"
                                               ng-readonly="true">
                                    </td>
                                    <!--<td><input class="form-control input-xs" ng-model="row.projectName"-->
                                               <!--ng-disabled="true"-->
                                               <!--ng-required="true" >-->
                                    <!--</td>-->
                                    <!--<td><input class="form-control input-xs" ng-model="row.productName"-->
                                               <!--ng-disabled="true"-->
                                               <!--ng-required="true" >-->
                                    <!--</td>-->
                                    <td><input class="form-control input-xs" ng-model="row.productNameCn"
                                               ng-disabled="true"
                                               ng-required="true" >
                                    </td>
                                    <!--<td>-->

                                        <!--<div class="form-control input-xs" style="width: 100%;" lookup-code="PLM_PROJECT_PRODUCT_CATEGORY" data-required="true" ng-model="row.productCategory"-->
                                             <!--ng-disabled="true"-->
                                             <!--required  id="productCategory" name="productCategory">-->
                                        <!--</div>-->

                                    <!--</td>-->
                                    <td><input class="form-control input-xs" ng-model="row.supplierName"
                                               ng-disabled="true"
                                               ng-required="true" >
                                    </td>
                                    <td><input class="form-control input-xs" ng-model="row.producer"
                                               ng-disabled="true"
                                               ng-required="true" >
                                    </td>
                                    <td><input class="form-control input-xs" ng-model="row.batchNumber"
                                               ng-disabled="headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='ABANDONED'"
                                               ng-required="true" >
                                    </td>
                                    <td><input class="form-control input-xs" ng-model="row.complaintSamplesNumber"
                                               ng-disabled="headerData.productExceptionBillStatus=='CLOSED'||headerData.productExceptionBillStatus=='ABANDONED'"
                                                >
                                    </td>


                                </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>

                </div>
                <!-- tabContent -->
            </div>


        </div>
    </div>

    <div class="modal fade" id="saveModal" tabindex="-1"
         data-backdrop="static" role="dialog"
         aria-labelledby="accessoryModalLabel">
        <div class="modal-dialog " style="margin-top: 5%;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"
                            aria-hidden="true">&times;
                    </button>
                    <h4 class="modal-title pull-left" id="saveTitle">保存</h4>
                </div>
                <div class="modal-body">
                    <div class="row"></div>

                    <!--<div class="form-group col-xs-12 col-md-12">-->
                    <!--<div class="input-group input-group-xs">-->

                    <!--<label class="input-group-addon bn">-->
                    <!--<span class="w100">驳回原因</span>-->
                    <!--</label>-->

                    <!--<input type="text" ng-disabled="false" class="form-control radius3"-->
                    <!--ng-model="rejectReason">-->
                    <!--</div>-->
                    <!--</div>-->
                    <span style="font-size: medium">录入数据未保存,是否保存</span>
                    <div class="row"></div>

                </div>
                <div class="modal-footer ">
                    <div style="text-align: center">
                        <button style="" type="button" class="btn btn-default"
                                ng-click="closeHeadTab()"
                                data-dismiss="modal">否
                        </button>
                        <button type="button" id="saveUnsavedButton"
                                ng-click="btnSave(plmProductExceptionInfoForm.$invalid)" class="btn btn-primary mr10">是
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <div lov-list="exceptionProductLov" role="dialog" data-title="选择异常产品" id="exceptionProductLovId" ng-model="current.em"
         data-url="findPlmDevelopmentInfoInfo"
         data-dynamic-params='{"plmProductExceptionInfoId": plmProductExceptionInfoId}'
         data-callback="selectExceptionProductReturn"
         data-auto-request="false"
         data-return-value=""
         data-return-type="key"
         data-pagination="{'pageIndex':'1','pageRows':'5'}"
         data-checked-type="radio"
         data-keys="{'name':'Barcode','key':'plmDevelopmentInfoId','value':'barcode'}"
         data-show-index="false"
         data-type="competitor"
         data-other-column="[{'key':'productName','name':'产品名称'},{'name':'产品品类','key':'productCategoryName'},{'name':'生产商名称','key':'producer'}]"
         data-search-key="[{'key':'productName_like','placeholder':'产品名称'},
                          {'key':'producerName_like','placeholder':'生产商名称'}]"
    >
    </div>




</div>