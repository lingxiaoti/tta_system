<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <title>下载页面</title>
    <script src="../../../../../plugin/jquery-3.3.1.min.js" type="text/javascript"></script>
    <style>
        body, html {
            height: 100%;
            padding: 0;
            margin: 0;
        }

        a.close {
            color: #666;
            font-size: 14px;
            position: absolute;
            right: 20px;
            bottom: 20px;
            text-decoration: none;
        }

        .loading {
            background: url("../img/loading1.gif") center;
            height: 5px;
            width: 60%;
            margin: 0 auto;
        }

        #box {
            position: absolute;
            top: 50%;
            height: 186px;
            width: 100%;

        }

        #container {
            position: relative;
            text-align: center;
            border: 1px solid #ddd;
            box-shadow: #ccc 0 0 20px;
            padding: 20px;
            margin: -93px 15% 0 15%;

        }
    </style>
</head>
<body>
<div id="box">
    <div id="container">
        <h3>《 <span id="name"></span> 》</h3>

        <div id="result">
            <p> PDF正在生成请耐心等候!</p>
            <div class="loading"></div>
        </div>
        <p>已用时间 <span id="timer" style="color:#ff0000;">00</span></p>
        <a href="javascript:self.close()" class="close">[关闭]</a>
    </div>
</div>
</body>
<script>
    $(function () {
        function downByBlob_1(url,name) {
            var downloadURL = url;
            let xhr = new XMLHttpRequest();
            let fileName = name; // 文件名称
            xhr.open('GET', downloadURL, true);
            xhr.responseType = 'arraybuffer';
            //xhr.setRequestHeader('xx', 'xxxxx') // 请求头中添加信息
            xhr.onload = function () {
                if (this.status === 200) {
                    let type = xhr.getResponseHeader('Content-Type');
                    let blob = new Blob([this.response], { type: type });
                    if (typeof window.navigator.msSaveBlob !== 'undefined') {
                        /*
                         * IE workaround for "HTML7007: One or more blob URLs were revoked by closing
                         * the blob for which they were created. These URLs will no longer resolve as
                         * the data backing the URL has been freed."
                         */
                        window.navigator.msSaveBlob(blob, fileName);
                    } else {
                        let URL = window.URL || window.webkitURL;
                        let objectUrl = URL.createObjectURL(blob);
                        console.log(objectUrl);
                        //"blob:http://localhost:10614/3e48b856-fca6-4e4c-b780-1c4a7066f42e"
                        if (fileName) {
                            //window.location = objectUrl;
                            var a = document.createElement('a');
                                a.href = objectUrl;
                                 a.download = fileName;
                                document.body.appendChild(a);
                                 a.click();
                                 a.remove();

                            //self.close();
                            //self.close();
                            // var a = document.createElement('a');
                            // // safari doesn't support this yet
                            // if (typeof a.download === 'undefined') {
                            //     window.location = objectUrl
                            //  //   self.close();
                            // } else {
                            //     a.href = objectUrl;
                            //     a.download = fileName;
                            //     document.body.appendChild(a);
                            //     a.click();
                            //     a.remove();
                            //  //   self.close();
                            // }
                        }
                    }
                    clearInterval(timer);
                }else {
                    clearInterval(timer);
                    alert(xhr.statusText);
                }
            };
            xhr.send();
        }
        if (!sessionStorage.pdfDownloadParams) {
            $('#container').html('参数错误');
            return;
        }
        var json = JSON.parse(sessionStorage.pdfDownloadParams);
        sessionStorage.removeItem('pdfDownloadParams');// 清除下载参数
        $('#name').text(json.title);
        downByBlob_1(json.url,json.name);
      //  window.location.href = json.url;
        window.onload = function() {
          //  alert("I'm the new location and I'm loaded!");
        };
        document.onreadystatechange = subSomething;//当页面加载状态改变的时候执行这个方法.
        function subSomething() {
          //  alert(document.readyState);
            if(document.readyState == "complete"){ //当页面加载状态为完全结束时进入
                //你要做的操作。
            }
        }
        var _time = {
            m: 0,
            s: 0
        };
        var timer = setInterval(function () {
            _time.s++;
            if (_time.s === 60) {
                _time.m++;
                _time.s = 0;
            }
            var str = _time.m > 0 ? _time.m + '分' + (_time.s < 10 ? '0' + _time.s + '秒' : _time.s + '秒') : (_time.s < 10 ? '0' + _time.s + '秒' : _time.s + '秒');
            $('#timer').text(str);

        }, 1000);

    })
</script>
</html>